// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================================================
// 1. ENUMS
// =========================================================

enum UserRole {
  ADMIN
  WAITER
  KITCHEN
  CUSTOMER
}

enum TableStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  INACTIVE
}

enum ProductStatus {
  AVAILABLE
  UNAVAILABLE
  SOLD_OUT
}

enum OrderStatus {
  PENDING
  ACCEPTED
  REJECTED
  PREPARING
  READY
  SERVED
  COMPLETED
  CANCELLED
}

enum DiscountType {
  PERCENT
  FIXED
}

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum PointsTransactionType {
  EARN
  REDEEM
  EXPIRED
  ADJUSTMENT
}

// =========================================================
// 2. USER MANAGEMENT
// =========================================================

model User {
  id       String   @id @default(uuid())
  email    String   @unique
  password String // Hash password
  name     String
  googleId String?  @unique @map("google_id")
  role     UserRole @default(CUSTOMER)
  phone    String?
  avatar   String?

  isEmailVerified   Boolean @default(false) @map("is_email_verified")
  verificationToken String? @map("verification_token")

  resetPasswordToken   String?   @map("reset_password_token")
  resetPasswordExpires DateTime? @map("reset_password_expires")

  // Relations
  orders             Order[]
  reviews            Review[]
  assignedTables     Table[]             @relation("WaiterTables")
  loyaltyPoints      LoyaltyPoints?
  pointsTransactions PointsTransaction[]
  voucherRedemptions VoucherRedemption[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// =========================================================
// 3. TABLE MANAGEMENT
// =========================================================

model Table {
  id          String      @id @default(uuid())
  tableNumber String      @unique @map("table_number")
  capacity    Int
  location    String?
  status      TableStatus @default(AVAILABLE)

  // QR Code info
  qrToken          String?   @unique @map("qr_token")
  qrTokenCreatedAt DateTime? @map("qr_token_created_at")

  // Waiter Assignment
  assignedWaiterId String? @map("assigned_waiter_id")
  assignedWaiter   User?   @relation("WaiterTables", fields: [assignedWaiterId], references: [id])

  // Relations
  orders Order[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("tables")
}

// =========================================================
// 4. MENU MANAGEMENT 
// =========================================================

model Category {
  id           String  @id @default(uuid())
  name         String  @unique
  description  String?
  displayOrder Int     @default(0) @map("display_order")
  isActive     Boolean @default(true) @map("is_active")

  // Relations
  products Product[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("categories")
}

model Product {
  id                String        @id @default(uuid())
  name              String
  description       String?
  allergens         String?       @map("allergens")
  price             Decimal       @db.Decimal(10, 2)
  prepTimeMinutes   Int?          @map("prep_time_minutes")
  status            ProductStatus @default(AVAILABLE)
  isChefRecommended Boolean       @default(false) @map("is_chef_recommended")
  orderCount        Int           @default(0) @map("order_count")

  // Relations
  categoryId     String                 @map("category_id")
  category       Category               @relation(fields: [categoryId], references: [id])
  images         ProductImage[]
  modifierGroups ProductModifierGroup[]
  orderItems     OrderItem[]
  reviews        Review[]
  createdAt      DateTime               @default(now()) @map("created_at")
  updatedAt      DateTime               @updatedAt @map("updated_at")

  @@map("products")
}

model ProductImage {
  id        String  @id @default(uuid())
  url       String
  isPrimary Boolean @default(false) @map("is_primary")

  productId String   @map("product_id")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@map("product_images")
}

// =========================================================
// 5. MODIFIERS (Topping, Size, Options)
// =========================================================

model ModifierGroup {
  id            String  @id @default(uuid())
  name          String
  selectionType String  @map("selection_type") // 'SINGLE' or 'MULTIPLE'
  isRequired    Boolean @default(false) @map("is_required")
  minSelections Int     @default(0) @map("min_selections")
  maxSelections Int     @default(1) @map("max_selections")

  // Relations
  options  ModifierOption[]
  products ProductModifierGroup[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("modifier_groups")
}

model ModifierOption {
  id              String  @id @default(uuid())
  name            String // Ví dụ: "Ít đường", "Size L"
  priceAdjustment Decimal @default(0) @map("price_adjustment") @db.Decimal(10, 2) // Tiền thêm (+5k)

  groupId String        @map("group_id")
  group   ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  // Relations
  orderItemModifiers OrderItemModifier[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("modifier_options")
}

// Bảng trung gian để nối Product và ModifierGroup (Many-to-Many)
model ProductModifierGroup {
  productId       String @map("product_id")
  modifierGroupId String @map("modifier_group_id")
  displayOrder    Int    @default(0)

  product       Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  modifierGroup ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)

  @@id([productId, modifierGroupId])
  @@map("product_modifier_groups")
}

// =========================================================
// 6. ORDERING SYSTEM
// =========================================================

model Order {
  id            String        @id @default(uuid())
  totalAmount   Decimal       @default(0) @map("total_amount") @db.Decimal(10, 2)
  guestCount    Int           @default(1) @map("guest_count")
  status        OrderStatus   @default(PENDING)
  notes         String?
  discountType  DiscountType? @map("discount_type")
  discountValue Decimal       @default(0) @map("discount_value") @db.Decimal(10, 2)

  // Relations
  tableId String @map("table_id")
  table   Table  @relation(fields: [tableId], references: [id])

  customerId String? @map("customer_id")
  customer   User?   @relation(fields: [customerId], references: [id])

  items              OrderItem[]
  pointsTransactions PointsTransaction[]
  voucherRedemptions VoucherRedemption[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("orders")
}

model OrderItem {
  id         String  @id @default(uuid())
  quantity   Int     @default(1)
  unitPrice  Decimal @map("unit_price") @db.Decimal(10, 2)
  totalPrice Decimal @map("total_price") @db.Decimal(10, 2)
  notes      String?

  // Relations
  orderId String @map("order_id")
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id])

  modifiers OrderItemModifier[]

  @@map("order_items")
}

model OrderItemModifier {
  id           String  @id @default(uuid())
  priceAtOrder Decimal @map("price_at_order") @db.Decimal(10, 2)

  orderItemId String    @map("order_item_id")
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  modifierOptionId String         @map("modifier_option_id")
  modifierOption   ModifierOption @relation(fields: [modifierOptionId], references: [id])

  @@map("order_item_modifiers")
}

// =========================================================
// 7. REVIEWS (Added via Task 6.3)
// =========================================================

model Review {
  id      String  @id @default(uuid())
  rating  Int     @default(5) // 1-5
  comment String?

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("reviews")
}

// =========================================================
// 8. LOYALTY POINTS SYSTEM
// =========================================================

model LoyaltyPoints {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  points        Int         @default(0)
  tier          LoyaltyTier @default(BRONZE)
  totalEarned   Int         @default(0) @map("total_earned")
  totalRedeemed Int         @default(0) @map("total_redeemed")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("loyalty_points")
}

model PointsTransaction {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  points      Int // Positive for EARN, negative for REDEEM
  type        PointsTransactionType
  description String? // e.g., "Order #123", "Voucher redemption"

  orderId String? @map("order_id")
  order   Order?  @relation(fields: [orderId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([orderId])
  @@index([createdAt])
  @@map("points_transactions")
}

model Voucher {
  id          String  @id @default(uuid())
  code        String  @unique // e.g., "WELCOME10", "VIP50"
  name        String // Display name
  description String? // Description for customers

  discountType   DiscountType @map("discount_type")
  discountValue  Decimal      @map("discount_value") @db.Decimal(10, 2)
  minOrderAmount Decimal?     @map("min_order_amount") @db.Decimal(10, 2) // Minimum order to use

  maxUses   Int? @map("max_uses") // null = unlimited
  usedCount Int  @default(0) @map("used_count")

  expiryDate DateTime? @map("expiry_date")
  isActive   Boolean   @default(true) @map("is_active")

  // Relations
  redemptions VoucherRedemption[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([code])
  @@index([isActive])
  @@map("vouchers")
}

model VoucherRedemption {
  id     String @id @default(uuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  voucherId String  @map("voucher_id")
  voucher   Voucher @relation(fields: [voucherId], references: [id], onDelete: Cascade)

  orderId String @map("order_id")
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  discountAmount Decimal @map("discount_amount") @db.Decimal(10, 2)

  redeemedAt DateTime @default(now()) @map("redeemed_at")

  @@index([userId])
  @@index([voucherId])
  @@index([orderId])
  @@map("voucher_redemptions")
}

// Add relation to Order model for voucher redemptions
